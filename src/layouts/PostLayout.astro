---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'
import Citation from '@/components/ui/Citation.astro'

import { themeConfig } from '@/config'

const {
  title,
  description,
  pubDate,
  updatedDate,
  type,
  readingTime,
  toc,
  doi,
  zenodoUrl,
  authors,
  keywords,
  version
} = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`

// Citation metadata helpers
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).toString()
const doiUrl = doi ? `https://doi.org/${doi}` : null
const hasCitationMetadata = !!doi
// Use authors from frontmatter, or fall back to site author
const citationAuthors = authors?.length ? authors : [{ name: themeConfig.site.author }]
// Format date for citation_publication_date (YYYY/MM/DD)
const citationDate = pubDate.toISOString().split('T')[0].replace(/-/g, '/')
---

<BaseLayout title={`${title} · ${themeConfig.site.title}`} description={description} type="post">
  <BaseHead
    title={`${title} · ${themeConfig.site.title}`}
    description={description}
    ogImage={ogImage}
    slot="head"
  />

  {/* Highwire / Google Scholar citation meta tags (when DOI present) */}
  {hasCitationMetadata && (
    <Fragment slot="head">
      <meta name="citation_title" content={title} />
      {citationAuthors.map((author) => (
        <meta name="citation_author" content={author.name} />
      ))}
      <meta name="citation_publication_date" content={citationDate} />
      <meta name="citation_doi" content={doi} />
      <meta name="citation_fulltext_html_url" content={canonicalUrl} />
      <meta name="citation_abstract" content={description} />
      {keywords?.length && <meta name="citation_keywords" content={keywords.join('; ')} />}
      <meta name="citation_publisher" content={themeConfig.site.title} />
      {zenodoUrl && <meta name="citation_pdf_url" content={zenodoUrl} />}
    </Fragment>
  )}

  {/* Dublin Core meta tags for broader compatibility (when DOI present) */}
  {hasCitationMetadata && (
    <Fragment slot="head">
      <meta name="DC.title" content={title} />
      {citationAuthors.map((author) => (
        <meta name="DC.creator" content={author.name} />
      ))}
      <meta name="DC.date" content={pubDate.toISOString().split('T')[0]} />
      <meta name="DC.identifier" content={doiUrl!} />
      <meta name="DC.description" content={description} />
      <meta name="DC.publisher" content={themeConfig.site.title} />
      <meta name="DC.type" content="Text" />
      {keywords?.length && <meta name="DC.subject" content={keywords.join('; ')} />}
    </Fragment>
  )}

  {/* Schema.org JSON-LD - ScholarlyArticle when DOI present, Article otherwise */}
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': hasCitationMetadata ? 'ScholarlyArticle' : 'Article',
      headline: title,
      description: description,
      abstract: hasCitationMetadata ? description : undefined,
      image: new URL(ogImage, Astro.site).href,
      datePublished: pubDate.toISOString(),
      dateModified: (updatedDate ?? pubDate).toISOString(),
      url: canonicalUrl,
      ...(doiUrl ? { identifier: doiUrl, sameAs: doiUrl } : {}),
      ...(version ? { version: version } : {}),
      author: citationAuthors.map((author) => ({
        '@type': 'Person',
        name: author.name,
        ...(author.orcid ? { identifier: `https://orcid.org/${author.orcid}`, sameAs: `https://orcid.org/${author.orcid}` } : {}),
        url: new URL('/about', Astro.site).href,
      })),
      publisher: {
        '@type': 'Organization',
        name: themeConfig.site.title,
        url: Astro.site,
      },
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': Astro.url.href,
      },
      ...(keywords?.length ? { keywords: keywords } : {}),
    })}
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <div class="title-header">
            <h1>{title}</h1>
          </div>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
          {doi && (
            <Citation
              title={title}
              doi={doi}
              url={canonicalUrl}
              pubDate={pubDate}
              authors={authors}
            />
          )}
        </div>
        <slot />
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }

  .title-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .title-header h1 {
    margin: 0;
    flex: 1;
  }

  @media (max-width: 640px) {
    .title-header {
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start;
    }
  }
</style>
